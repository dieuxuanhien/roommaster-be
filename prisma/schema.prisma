generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum BookingStatus {
  PENDING
  CONFIRMED
  CHECKED_IN
  PARTIALLY_CHECKED_OUT
  CHECKED_OUT
  CANCELLED
}

enum RoomStatus {
  AVAILABLE
  RESERVED
  OCCUPIED
  CLEANING
  MAINTENANCE
  OUT_OF_SERVICE
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  BANK_TRANSFER
  E_WALLET
}

enum TransactionType {
  DEPOSIT // Tiền cọc
  ROOM_CHARGE // Thanh toán tiền phòng
  SERVICE_CHARGE // Thanh toán dịch vụ
  REFUND // Hoàn tiền cho khách
  ADJUSTMENT // Điều chỉnh tăng/giảm số dư
}

// ==================== MODELS ====================

model Employee {
  id       String @id @default(cuid())
  name     String
  username String @unique
  password String
  role     String @default("STAFF") // ADMIN, RECEPTIONIST, HOUSEKEEPING

  transactions     Transaction[]
  bookingHistories BookingHistory[]

  updatedAt DateTime @updatedAt
  tokens    Token[]
}

model Customer {
  id       String  @id @default(cuid())
  fullName String
  email    String?
  phone    String  @unique
  idNumber String? // CMND/CCCD
  address  String? @db.Text
  password String

  bookings         Booking[]
  bookingCustomers BookingCustomer[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tokens    Token[]

  @@index([phone])
}

model RoomType {
  id            String  @id @default(cuid())
  name          String
  capacity      Int
  pricePerNight Decimal @db.Decimal(10, 2)
  amenities     Json?

  rooms        Room[]
  bookingRooms BookingRoom[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Room {
  id         String     @id @default(cuid())
  roomNumber String     @unique
  floor      Int
  status     RoomStatus @default(AVAILABLE)
  roomTypeId String

  roomType     RoomType      @relation(fields: [roomTypeId], references: [id])
  bookingRooms BookingRoom[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
}

model Booking {
  id          String        @id @default(cuid())
  bookingCode String        @unique
  status      BookingStatus @default(PENDING)

  primaryCustomerId String
  primaryCustomer   Customer @relation(fields: [primaryCustomerId], references: [id])

  checkInDate  DateTime
  checkOutDate DateTime
  totalGuests  Int

  // TÀI CHÍNH TỔNG QUÁT (Tổng hợp từ BookingRooms)
  totalAmount  Decimal @default(0) @db.Decimal(10, 2)
  totalDeposit Decimal @default(0) @db.Decimal(10, 2)
  totalPaid    Decimal @default(0) @db.Decimal(10, 2)
  balance      Decimal @default(0) @db.Decimal(10, 2)

  bookingRooms     BookingRoom[]
  bookingCustomers BookingCustomer[]
  transactions     Transaction[]
  serviceUsages    ServiceUsage[]
  histories        BookingHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([bookingCode])
  @@index([status])
}

model BookingRoom {
  id         String @id @default(cuid())
  bookingId  String
  roomId     String
  roomTypeId String

  checkInDate    DateTime
  checkOutDate   DateTime
  actualCheckIn  DateTime?
  actualCheckOut DateTime?

  pricePerNight   Decimal @db.Decimal(10, 2)
  depositAmount   Decimal @default(0) @db.Decimal(10, 2)
  subtotalRoom    Decimal @default(0) @db.Decimal(10, 2)
  subtotalService Decimal @default(0) @db.Decimal(10, 2)
  totalAmount     Decimal @default(0) @db.Decimal(10, 2)
  totalPaid       Decimal @default(0) @db.Decimal(10, 2)
  balance         Decimal @default(0) @db.Decimal(10, 2)

  status BookingStatus @default(PENDING)

  booking          Booking           @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  room             Room              @relation(fields: [roomId], references: [id])
  roomType         RoomType          @relation(fields: [roomTypeId], references: [id])
  bookingCustomers BookingCustomer[]
  transactions     Transaction[]
  serviceUsages    ServiceUsage[]

  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  transactionDetails TransactionDetail[]

  @@index([status])
}

model BookingCustomer {
  id            String  @id @default(cuid())
  bookingId     String
  customerId    String
  bookingRoomId String?

  isPrimary Boolean @default(false)

  booking     Booking      @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  customer    Customer     @relation(fields: [customerId], references: [id])
  bookingRoom BookingRoom? @relation(fields: [bookingRoomId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([bookingId, customerId])
}

model Transaction {
  id            String  @id @default(cuid())
  bookingId     String
  bookingRoomId String?

  type   TransactionType
  amount Decimal           @db.Decimal(10, 2)
  method PaymentMethod
  status TransactionStatus @default(PENDING)

  processedById String?
  processedBy   Employee? @relation(fields: [processedById], references: [id])

  // Quan hệ tới chi tiết thanh toán
  details TransactionDetail[]

  transactionRef String?
  occurredAt     DateTime @default(now())
  description    String?

  booking     Booking      @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  bookingRoom BookingRoom? @relation(fields: [bookingRoomId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TransactionDetail {
  id            String @id @default(cuid())
  transactionId String

  // Số tiền phân bổ cho khoản mục này
  amount Decimal @db.Decimal(10, 2)

  // Liên kết tới cái cần thanh toán (Một trong hai cái này sẽ có giá trị)
  bookingRoomId  String? // Nếu thanh toán tiền phòng
  serviceUsageId String? // Nếu thanh toán dịch vụ cụ thể

  transaction  Transaction   @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  bookingRoom  BookingRoom?  @relation(fields: [bookingRoomId], references: [id])
  serviceUsage ServiceUsage? @relation(fields: [serviceUsageId], references: [id])

  createdAt DateTime @default(now())
}

model Service {
  id       String  @id @default(cuid())
  name     String
  price    Decimal @db.Decimal(10, 2)
  unit     String  @default("lần")
  isActive Boolean @default(true)

  serviceUsages ServiceUsage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ServiceUsage {
  id            String  @id @default(cuid())
  bookingId     String
  bookingRoomId String?

  serviceId  String
  quantity   Int     @default(1)
  unitPrice  Decimal @db.Decimal(10, 2)
  totalPrice Decimal @db.Decimal(10, 2)

  // Thêm quan hệ ngược để biết dịch vụ này đã được trả bao nhiêu tiền
  transactionDetails TransactionDetail[]

  booking     Booking      @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  bookingRoom BookingRoom? @relation(fields: [bookingRoomId], references: [id])
  service     Service      @relation(fields: [serviceId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BookingHistory {
  id         Int     @id @default(autoincrement())
  bookingId  String
  employeeId String?

  action  String
  changes Json?
  reason  String?

  booking  Booking   @relation(fields: [bookingId], references: [id])
  employee Employee? @relation(fields: [employeeId], references: [id])

  createdAt DateTime @default(now())
}

model Token {
  id          String   @id @default(cuid())
  token       String   @unique
  type        String // ACCESS, REFRESH, RESET_PASSWORD
  expires     DateTime
  blacklisted Boolean  @default(false)

  employeeId String?
  employee   Employee? @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
